<template>
  <form @submit.prevent="submit"
        v-form="creditCardForm"
        class="borderRadius25 marginRightAuto marginLeftAuto displayFlex
               bgWhisper">

    <div class="flex1 padding30">

      <!-- Name field -->
      <div class="marginBottom30 widthTwelve">

        <div class="marginBottom10">
          <label for="name" class="colorMidGray fontSize14">
            Your name
          </label>
        </div>

        <input id="name"
               type="text"
               class="inputText widthTwelve"
               v-model="creditCardData.name"
               pattern="[A-Za-z\s'\-]+"
               minlength="3"
               required>

        <div v-if="creditCardForm.state.wasSubmitted"
             class="marginTop12 widthTwelve colorRed fontSize14">
          <div v-if="creditCardForm.state.fields.name.valueMissing">
            Name is required.
          </div>
          <div v-else-if="creditCardForm.state.fields.name.tooShort">
            Please enter your first and last name.
          </div>
          <div v-else-if="creditCardForm.state.fields.name.patternMismatch">
            Please use only letters, spaces, dashes, and apostrophes.
          </div>
        </div>

      </div>

      <!-- Credit card number field -->
      <div class="marginBottom30 widthTwelve">

        <div class="marginBottom10">
          <label for="email" class="colorMidGray fontSize14">
            Credit card number
          </label>
        </div>

        <input id="cardNumber"
               type="text"
               class="inputText widthTwelve"
               v-model="creditCardData.cardNumber"
               maxlength="4"
               required>

        <div v-if="creditCardForm.state.wasSubmitted"
             class="marginTop12 widthTwelve colorRed fontSize14">
          <div v-if="creditCardForm.get('cardNumber').valueMissing">
            Credit card number is required.
          </div>
        </div>

      </div>

    </div>

    <div class="flex1 padding30">

      <!-- CVV Field -->
      <div class="marginBottom30 widthTwelve">

        <div class="marginBottom10">
          <label for="dob" class="colorMidGray fontSize14">
            CVV
          </label>
        </div>

        <input id="cvv"
               type="text"
               class="inputText widthThree"
               v-model="creditCardData.cvv"
               maxlength="4"
               required>

        <div v-if="creditCardForm.state.wasSubmitted"
             class="marginTop12 widthTwelve colorRed fontSize14">
          <div v-if="creditCardForm.get('cvv').valueMissing">
            CVV is required.
          </div>
        </div>

      </div>

      <!-- Card expiration field -->
      <div class="marginBottom30">

        <div class="marginBottom10">
          <label for="description" class="colorMidGray fontSize14">
            Card expiration date
          </label>
        </div>

        <div>
          <select id="expirationMonth"
                  v-model="creditCardData.expirationMonth"
                  v-custom-validator="[creditCardForm, expiryValidator]"
                  class="select marginRight20"
                  required>
            <option :value="undefined" disabled>Select a month</option>
            <option v-for="month in months" :value="month.key">
              {{ month.label }}
            </option>
          </select>

          <select id="expirationYear"
                  v-model="creditCardData.expirationYear"
                  v-custom-validator="[creditCardForm, expiryValidator]"
                  class="select"
                  required>
            <option :value="undefined" disabled>Select a year</option>
            <option v-for="year in years">
              {{ year }}
            </option>
          </select>
        </div>

        <div v-if="creditCardForm.state.wasSubmitted"
             class="marginTop12 widthTwelve colorRed fontSize14">
          <div v-if="creditCardForm.get('expirationMonth').valueMissing">
            Expiration month is required.
          </div>
          <div v-if="creditCardForm.get('expirationYear').valueMissing">
            Expiration year is required.
          </div>
          <div v-if="creditCardForm.get('expirationMonth').customError ||
                     creditCardForm.get('expirationYear').customError">
            Invalid Expiration Date.
          </div>
        </div>

      </div>

      <!-- Success message -->
      <transition name="fade">
        <div v-if="formSent" class="colorOlive fontSize18 textCenter">
          Item has been purchased.
        </div>
      </transition>

      <!-- Form buttons -->
      <div v-if="!formSent" class="textRight fontSize20">

        <!-- Hidden input to test ignoredFields option -->
        <input id="g-captcha-response" type="text" class="displayNone" required>

        <!-- Reset button -->
        <button type="reset"
                class="button circular width140 height50 marginRight30 bgGray">
          <span class="verticalMiddle">Reset</span>
          <reset-icon></reset-icon>
        </button>

        <!-- Submit button -->
        <button type="submit"
                class="button circular width150 height50"
                :class="{ 'disabled': creditCardForm.state.isInvalid }">
          <span class="verticalMiddle">Purchase</span>
          <check-icon></check-icon>
        </button>

      </div>

    </div>

  </form>
</template>

<script>
  import ResetIcon from './ResetIcon'
  import CheckIcon from './CheckIcon'
  import { months, years } from '../data'

  const { Stripe } = window

  export default {
    name: 'CreditCardForm',
    components: { ResetIcon, CheckIcon },
    data () {
      return {
        months,
        years,
        formSent: false,
        creditCardData: {},
        creditCardForm: this.$newVueForm()
      }
    },
    methods: {
      submit () {
        if (this.creditCardForm.state.isValid) {
          this.formSent = true
          console.log('VALID')
        } else {
          console.log('INVALID')
        }
      },
      expiryValidator () {
        const { expirationMonth, expirationYear } = this.creditCardData
        const err = !Stripe.card.validateExpiry(expirationMonth, expirationYear)
        this.creditCardForm.setCustomValidity('expirationMonth', err)
        this.creditCardForm.setCustomValidity('expirationYear', err)
        return err
      }
    }
  }
</script>
