(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory(require("babel-polyfill")):typeof define==="function"&&define.amd?define(["babel-polyfill"],factory):global.VueForm=factory(global.babelPolyfill)})(this,function(babelPolyfill){"use strict";var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}};var createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var get$1=function get$1(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get$1(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var set=function set(object,property,value,receiver){var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent!==null){set(parent,property,value,receiver)}}else if("value"in desc&&desc.writable){desc.value=value}else{var setter=desc.set;if(setter!==undefined){setter.call(receiver,value)}}return value};var slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var toConsumableArray=function(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}else{return Array.from(arr)}};var _window=window;var MutationObserver=_window.MutationObserver;var fieldTags="input, textarea, select";var attributes=["required","minlength","maxlength","pattern","max","min","step","type"];function extractValidity(el){var validity=el.validity;var tooShort=validity.tooShort;var valid=validity.valid;if(el.getAttribute){var minlength=el.getAttribute("minlength");if(minlength&&typeof tooShort==="undefined"){tooShort=el.value.length<minlength;if(tooShort){valid=false;var msg="Please lengthen this text to "+minlength+" characters or ";msg+="more (you are currently using "+el.value.length+" characters).";el.setCustomValidity(msg)}else{el.setCustomValidity("")}}}return{badInput:validity.badInput,customError:validity.customError,patternMismatch:validity.patternMismatch,rangeOverflow:validity.rangeOverflow,rangeUnderflow:validity.rangeUnderflow,stepMismatch:validity.stepMismatch,tooLong:validity.tooLong,tooShort:tooShort,typeMismatch:validity.typeMismatch,valid:valid,valueMissing:validity.valueMissing}}var createField=function createField(){var el=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{validity:{}};if(el.hasAttribute){return Object.assign({el:el,wasFocused:false},extractValidity(el))}else{return Object.assign({wasFocused:false},extractValidity(el))}};var VueForm=function(){function VueForm(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};classCallCheck(this,VueForm);var defaults$$1={wasFocusedClass:"wasFocused",wasSubmittedClass:"wasSubmitted",noValidate:true,requiredGroups:[],customValidators:{}};Object.assign(this,defaults$$1,options);this.$cache={fields:{},invalidFields:[],wasSubmitted:false,isInvalid:false,isValid:true};this.state=Object.assign({},this.$cache)}createClass(VueForm,[{key:"updateRequiredGroups",value:function updateRequiredGroups(){var el=this.el;if(el.hasAttribute("vf-required-groups")){this.requiredGroups=el.getAttribute("vf-required-groups").split(",")}}},{key:"updateState",value:function updateState(){var _this=this;var $cache=this.$cache,state=this.state;var update=function update(){return _this.state=Object.assign({},state,$cache)};if(this.Vue){this.Vue.nextTick(function(){return update()})}else{update()}}},{key:"registerFormElement",value:function registerFormElement(el,Vue){var _this2=this;this.Vue=Vue;this.el=el;this.el.noValidate=this.noValidate;this.updateRequiredGroups();this.el.addEventListener("submit",function(){_this2.$cache.wasSubmitted=true;_this2.el.classList.add(_this2.wasSubmittedClass);_this2.updateState()});this.el.addEventListener("reset",function(){_this2.$cache.wasSubmitted=false;_this2.el.classList.remove(_this2.wasSubmittedClass)});this.registerFieldElements(el.querySelectorAll(fieldTags),"added");this.updateState();this.observer=new MutationObserver(function(mutations){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=mutations[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var mutation=_step.value;var removedNodes=mutation.removedNodes,addedNodes=mutation.addedNodes,type=mutation.type,attributeName=mutation.attributeName;var rootNode=removedNodes[0]||addedNodes[0]||mutation.target;var isWhitelisted=attributes.indexOf(attributeName)!==-1;var isAllowed=type!=="attributes"||isWhitelisted;if(rootNode&&rootNode.hasAttribute&&isAllowed){var nodes=[].concat(toConsumableArray(rootNode.querySelectorAll(fieldTags)));if(fieldTags.indexOf(rootNode.tagName.toLowerCase())!==-1){nodes.push(rootNode)}if(removedNodes&&removedNodes.length){type="removed"}else if(addedNodes&&addedNodes.length){type="added"}_this2.registerFieldElements(nodes,type)}else if(rootNode&&attributeName==="vf-required-groups"){_this2.updateRequiredGroups()}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}});var options={attributes:true,subtree:true,childList:true};this.observer.observe(el,options)}},{key:"registerFieldElements",value:function registerFieldElements(nodes,type){var _this3=this;var promises=[];var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{var _loop=function _loop(){var node=_step2.value;var $cache=_this3.$cache;var id=node.getAttribute("id");var name=node.getAttribute("name");var hasIdField=id&&$cache.fields[id];var hasNameField=name&&$cache.fields[name];var finishValidation=function finishValidation(evt){var update=function update(resolve,hasCustomValidatorResult,result){if(hasCustomValidatorResult){if(id){_this3.setCustomValidity(id,result)}if(name){_this3.setCustomValidity(name,result)}}if(id){_this3.updateFormValidity(id)}if(name){_this3.updateFormValidity(name)}resolve()};return new Promise(function(resolve){var customValidator=_this3.customValidators[id||name];if(customValidator){var response=customValidator(evt);if(response&&response.then){response.then(function(result){return update(resolve,true,result)})}else{update(resolve,true,response)}}else{update(resolve)}})};if(type==="added"){if(id){$cache.fields[id]=createField(node);node.addEventListener("focus",function(_ref){var target=_ref.target;$cache.fields[id].wasFocused=true;target.classList.add(_this3.wasFocusedClass);_this3.updateState()})}var inputType=node.getAttribute("type");var isCheckable=["radio","checkbox"].indexOf(inputType)!==-1;var isSelect=node.tagName.toLowerCase()==="select";var eventType=isSelect||isCheckable?"change":"input";node.addEventListener(eventType,function(evt){setTimeout(function(){var target=evt.target;if(id){Object.assign($cache.fields[id],extractValidity(target))}if(name){_this3.updateNamedValidity(target)}finishValidation(evt).then(function(){return _this3.updateState()})},0)})}else if(hasIdField&&type==="attributes"){Object.assign($cache.fields[id],extractValidity(node))}else if((hasIdField||hasNameField)&&type==="removed"){$cache.fields[id||name]=createField()}if(name){_this3.updateNamedValidity(node)}promises.push(finishValidation({target:node}))};for(var _iterator2=nodes[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){_loop()}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}Promise.all(promises).then(function(){return _this3.updateState()})}},{key:"get",value:function get(id){if(!this.state.fields[id]){this.state.fields[id]=createField()}return this.state.fields[id]}},{key:"setCustomValidity",value:function setCustomValidity(id,invalid){var $cache=this.$cache;if($cache.fields[id]){var isBoolean=typeof invalid==="boolean";var isString=typeof invalid==="string";var isNonEmptyString=isString&&invalid.length>0;if(invalid&&(isBoolean||isNonEmptyString)){if(isNonEmptyString){$cache.fields[id].customMessage=invalid}else{invalid="Error"}}else{$cache.fields[id].customMessage=null;invalid=""}if($cache.fields[id].el){var el=$cache.fields[id].el;el.setCustomValidity(invalid);Object.assign($cache.fields[id],extractValidity(el))}else{$cache.fields[id].customError=invalid!=="";$cache.fields[id].valid=$cache.fields[id].valid&&invalid===""}}}},{key:"updateFormValidity",value:function updateFormValidity(id){var index=this.$cache.invalidFields.indexOf(id);var field=this.$cache.fields[id];var valid=field.valid||field.valid===undefined;if(valid&&index!==-1){this.$cache.invalidFields.splice(index,1);if(this.$cache.invalidFields.length===0){this.$cache.isValid=true;this.$cache.isInvalid=false}}else if(!valid&&index===-1){this.$cache.isValid=false;this.$cache.isInvalid=true;this.$cache.invalidFields.push(id)}}},{key:"updateNamedValidity",value:function updateNamedValidity(el){var name=el.getAttribute("name");var fields=this.$cache.fields;if(name&&(this.requiredGroups.indexOf(name)!==-1||fields[name])){var valueMissing=this.getNamedValueMissing(name);var validity={valueMissing:valueMissing,valid:!valueMissing};if(valueMissing===undefined){validity.valid=undefined}fields[name]=Object.assign({},fields[name],validity)}}},{key:"getNamedValueMissing",value:function getNamedValueMissing(name){var elements=[].concat(toConsumableArray(this.el.querySelectorAll("[name="+name+"]")));var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=elements[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var el=_step3.value;var isCheckable=["radio","checkbox"].indexOf(el.type)!==-1;if(isCheckable&&el.checked||!isCheckable&&el.value){return false}else if(elements.indexOf(el)===elements.length-1){return true}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}return undefined}}],[{key:"install",value:function install(Vue){Vue.prototype.$newVueForm=function(options){return new VueForm(options)};var bind=function bind(el,context){var formInstance=context.value;if(formInstance instanceof VueForm&&!formInstance.el){formInstance.registerFormElement(el,Vue)}};var unbind=function unbind(el,context){var formInstance=context.value;if(formInstance instanceof VueForm&&formInstance.observer){formInstance.observer.disconnect()}};Vue.directive("form",{bind:bind,componentUpdated:bind,unbind:unbind});Vue.directive("custom-validator",function(el,context){var _context$value=slicedToArray(context.value,2),formInstance=_context$value[0],customValidator=_context$value[1];if(formInstance instanceof VueForm){var _id=el.getAttribute("id");var _name=el.getAttribute("name");formInstance.customValidators[_id||_name]=customValidator}})}}]);return VueForm}();return VueForm});